const l="courses",d="meta",p="catalogs",m="requirements";function w(){return new Promise((e,o)=>{const r=indexedDB.open("db",3);r.onupgradeneeded=()=>{const s=r.result,n=r.transaction;if(n===null)throw new Error("IndexedDB upgrade transaction missing");const a=s.objectStoreNames.contains(l)?n.objectStore(l):s.createObjectStore(l,{keyPath:"code"});s.objectStoreNames.contains(d)||s.createObjectStore(d,{keyPath:"key"}),s.objectStoreNames.contains(p)||s.createObjectStore(p,{keyPath:"id"}),s.objectStoreNames.contains(m)||s.createObjectStore(m,{keyPath:"programId"}),a.indexNames.contains("name")||a.createIndex("name","name"),a.indexNames.contains("points")||a.createIndex("points","points"),a.indexNames.contains("median")||a.createIndex("median","median")},r.onsuccess=()=>{e(r.result)},r.onerror=()=>{o(r.error??new Error("Failed to open IndexedDB"))}})}async function y(e,o,r){const s=await w();return new Promise((n,a)=>{const t=s.transaction(e,o),i=t.objectStore(e),c=r(i);c!==null&&(c.onsuccess=()=>{n(c.result)},c.onerror=()=>{a(c.error??new Error("IndexedDB request failed"))}),t.oncomplete=()=>{s.close(),c===null&&n(void 0)},t.onerror=()=>{a(t.error??new Error("IndexedDB transaction failed"))},t.onabort=()=>{a(t.error??new Error("IndexedDB transaction aborted"))}})}async function O(e,o,r){const s=await w();return new Promise((n,a)=>{const t=s.transaction(e,o),i={};for(const c of e)i[c]=t.objectStore(c);r(i),t.oncomplete=()=>{s.close(),n()},t.onerror=()=>{a(t.error??new Error("IndexedDB transaction failed"))},t.onabort=()=>{a(t.error??new Error("IndexedDB transaction aborted"))}})}async function R(e){return await y(d,"readonly",r=>r.get(e))}async function F(e){await y(d,"readwrite",o=>(o.put(e),null))}async function M(e){const o=await w();await new Promise((r,s)=>{const n=o.transaction(l,"readwrite"),a=n.objectStore(l);for(const t of e)a.put(t);n.oncomplete=()=>{o.close(),r()},n.onerror=()=>{s(n.error??new Error("Failed to save courses"))},n.onabort=()=>{s(n.error??new Error("Course transaction aborted"))}})}async function A(e){const o=await w();await new Promise((r,s)=>{const n=o.transaction(p,"readwrite"),a=n.objectStore(p);for(const[t,i]of Object.entries(e))a.put({id:t,data:i});n.oncomplete=()=>{o.close(),r()},n.onerror=()=>{s(n.error??new Error("Failed to save catalogs"))},n.onabort=()=>{s(n.error??new Error("Catalog transaction aborted"))}})}async function _(){const e=await w();return new Promise((o,r)=>{const s={},n=e.transaction(p,"readonly"),t=n.objectStore(p).openCursor();t.onsuccess=()=>{const i=t.result;if(i===null)return;const c=i.value;s[c.id]=c.data,i.continue()},t.onerror=()=>{r(t.error??new Error("Failed to read catalogs"))},n.oncomplete=()=>{e.close(),o(s)},n.onerror=()=>{r(n.error??new Error("Catalog transaction failed"))},n.onabort=()=>{r(n.error??new Error("Catalog transaction aborted"))}})}async function T(e){return await y(m,"readonly",r=>r.get(e))}async function j(e,o){await O([m,d],"readwrite",r=>{r[m].put(e),o!==void 0&&o.length>0&&o!==e.programId&&r[m].delete(o),r[d].put({key:"requirementsActiveCatalogId",value:e.catalogId}),r[d].put({key:"requirementsActiveFacultyId",value:e.facultyId}),r[d].put({key:"requirementsActiveProgramId",value:e.programId}),r[d].put({key:"requirementsActivePath",value:e.path??""})})}async function V(e,o,r,s){if(o<0)return[];const n=await w();return new Promise((a,t)=>{const i=[],c=n.transaction(l,"readonly"),f=c.objectStore(l),C=k(f,r),P=B(s);let h=0,v=!1;const x=C.count();x.onsuccess=()=>{h=x.result,D()},x.onerror=()=>{t(x.error??new Error("Failed to count courses"))};function D(){const b=C.openCursor(null,P);let g=!1;b.onsuccess=()=>{const u=b.result;if(u===null||i.length>=e){v||(v=!0,N());return}if(!g&&o>0){g=!0,u.advance(o);return}const E=u.value;if(I(E,r)){u.continue();return}i.push(E),u.continue()},b.onerror=()=>{t(b.error??new Error("Failed to read courses"))}}function N(){if(e-i.length<=0)return;const g=Math.max(0,o-h),u=f.openCursor();let E=!1;u.onsuccess=()=>{const S=u.result;if(S===null||i.length>=e)return;const q=S.value;if(!I(q,r)){S.continue();return}if(!E&&g>0){E=!0,S.advance(g);return}i.push(q),S.continue()},u.onerror=()=>{t(u.error??new Error("Failed to read courses"))}}c.oncomplete=()=>{n.close(),a(i)},c.onerror=()=>{t(c.error??new Error("Course transaction failed"))},c.onabort=()=>{t(c.error??new Error("Course transaction aborted"))}})}async function U(e,o){const r=await w();return new Promise((s,n)=>{const a=[],t=r.transaction(l,"readonly"),c=t.objectStore(l).openCursor();c.onsuccess=()=>{const f=c.result;f===null||a.length>=e||(a.push(f.value),f.continue())},c.onerror=()=>{n(c.error??new Error("Failed to read courses"))},t.oncomplete=()=>{r.close(),s(a)},t.onerror=()=>{n(t.error??new Error("Course transaction failed"))},t.onabort=()=>{n(t.error??new Error("Course transaction aborted"))}})}function k(e,o){switch(o){case"code":return e;case"name":return e.index("name");case"points":return e.index("points");case"median":return e.index("median")}}function B(e){return e==="desc"?"prev":"next"}function I(e,o){switch(o){case"code":return e.code.length===0;case"name":return e.name===void 0;case"points":return e.points===void 0||!Number.isFinite(e.points);case"median":return e.median===void 0||!Number.isFinite(e.median)}}export{V as a,U as b,A as c,_ as d,T as e,R as g,M as p,j as r,F as s};
